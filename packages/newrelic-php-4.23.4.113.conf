name:      "newrelic-php-4.23.4.113"
version:   "4.23.4.113"

sources [
  { url: "http://download.newrelic.com/php_agent/archive/4.23.4.113/newrelic-php5-4.23.4.113-linux.tar.gz",
    sha256: "c33b408c4d860ef44633740585bf12ede293b193a852735dd0a62775cbd7ca3f" }
]

build_depends [ { package: "build-essential" } ]
depends       [ { os: "ubuntu" },
                { runtime: "php-apache-5" } ]
provides      [ { package: "newrelic-php" },
                { package: "newrelic-php-4" },
                { package: "newrelic-php-4.23.4.113" } ]

build (
  # Prep package for processing
  gzip -dc newrelic*.tar.gz | tar xf -
  mv newrelic-php5-4.23.4.113-linux newrelic
  cp -a newrelic /opt/apcera/
  chmod a+rw -R /opt/apcera/newrelic
  chown -R runner:runner /opt/apcera/newrelic

  # Begin New Relic for PHP manual installation steps
  cp -a /opt/apcera/newrelic/agent/x64/newrelic-20121212.so /opt/apcera/php-5.5.15/lib/php/extensions/no-debug-non-zts-20121212/newrelic.so

  cp -a /opt/apcera/newrelic/daemon/newrelic-daemon.x64 /usr/bin/newrelic-daemon

  chmod a+x /usr/bin/newrelic-daemon
  chown runner:runner /usr/bin/newrelic-daemon
  mkdir -p /var/log/newrelic
  chmod 755 /var/log/newrelic
  chown -R runner:runner /var/log/newrelic

  # Create the newrelic.ini.template file
  cat <<EOF > /opt/apcera/newrelic/scripts/newrelic.ini.template
extension = "newrelic.so"
[newrelic]
newrelic.license = {{env_map.NEW_RELIC_LICENSE_KEY}}
newrelic.logfile = "/var/log/newrelic/php_agent.log"
newrelic.appname = {{name}};{{env_map.CNTM_INSTANCE_UUID}}
newrelic.daemon.logfile = "/var/log/newrelic/newrelic-daemon.log"
EOF

  # Register the template we just created.
  echo "/opt/apcera/newrelic/scripts/newrelic.ini.template" > /TEMPLATES
)
